{% extends "layout.html" %}

{% block title %}
    Edit Lesson
{% endblock %}

{% block main %}
<div class="container mx-auto px-4">
    <h1 class="text-2xl font-semibold text-gray-900">Edit Lesson</h1>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="mt-4">
            {{ form.lesson_summary.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.lesson_summary(class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm") }}
        </div>
        <div class="mt-4">
            {{ form.strengths.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.strengths(class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm") }}
        </div>
        <div class="mt-4">
            {{ form.areas_to_improve.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.areas_to_improve(class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm") }}
        </div>
        <div class="mt-4">
            {{ form.new_words.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.new_words(id="textarea_new_words", value=new_words, class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm") }}
            <div id="new-words" class="mt-2"></div>
            <input type="hidden" id="hidden_new_words" name="new_words" value="{{ new_words|tojson }}">
        </div>
        <div class="mt-4">
            {{ form.new_phrases.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.new_phrases(id="textarea_new_phrases", value=new_phrases, class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm") }}
            <div id="new-phrases" class="mt-2"></div>
            <input type="hidden" id="hidden_new_phrases" name="new_phrases" value="{{ new_phrases|tojson }}">
        </div>
        <div class="mt-4">
            {{ form.submit(class="mt-3 w-full px-6 py-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500") }}
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function createSpan(container, value, hiddenInput) {
        const span = document.createElement('span');
        span.textContent = value;
        span.className = 'inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2';
    
        const button = document.createElement('button');
        button.textContent = 'x';
        button.className = 'ml-2 text-red-500 hover:text-red-700';
        button.addEventListener('click', function() {
            container.removeChild(span);
            updateHiddenInput(hiddenInput, container);
        });
    
        span.appendChild(button);
        container.appendChild(span);
    }
    
    function updateHiddenInput(hiddenInput, container) {
        const values = Array.from(container.children).map(child => child.textContent.slice(0, -1));  // Remove the 'x' at the end
        hiddenInput.value = JSON.stringify(values);
    }
    
    function handleInput(inputId, containerId, hiddenInputId, initialValues) {
        const input = document.getElementById(inputId);
        const container = document.getElementById(containerId);
        const hiddenInput = document.getElementById(hiddenInputId);
    
        // Check if initialValues is a string
        const values = typeof initialValues === 'string' ? JSON.parse(initialValues) : initialValues;
    
        // Populate the container with span elements when the page loads
        values.forEach(function(value) {
            createSpan(container, value, hiddenInput);
        });
    
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();  // Prevent form submission
                const value = this.value.trim();
                if (value !== '') {
                    createSpan(container, value, hiddenInput);
                    this.value = '';
                    updateHiddenInput(hiddenInput, container);  // Update the hidden input
                }
            }
        });
    }

    document.querySelector('form').addEventListener('submit', function(event) {
        // In the form submit event, set the value of the hidden inputs instead of non-existent inputs
        document.getElementById('hidden_new_words').value = document.getElementById('textarea_new_words').value;
        document.getElementById('hidden_new_phrases').value = document.getElementById('textarea_new_phrases').value;
    });
    
    // Pass the new_words and new_phrases as arguments to handleInput
    handleInput('textarea_new_words', 'new-words', 'hidden_new_words', JSON.parse(document.getElementById('hidden_new_words').value));
    handleInput('textarea_new_phrases', 'new-phrases', 'hidden_new_phrases', JSON.parse(document.getElementById('hidden_new_phrases').value));
</script>
{% endblock %}

class JsonEncodedDict(types.TypeDecorator):
    impl = types.Text

    def process_bind_param(self, value, dialect):
        if value is None:
            return '{}'
        else:
            return json.dumps(value)

    def process_result_value(self, value, dialect):
        if value is None:
            return {}
        else:
            return json.loads(value)


            @app.route('/teacher/edit_lesson/<int:lesson_id>', methods=['GET', 'POST'])
                @login_required
                def edit_lesson(lesson_id):
                    app.logger.info(f"Editing lesson with ID {lesson_id}")
                    
                    if session['user_type'] != 'teacher':
                        app.logger.info("User is not a teacher")
                        return redirect(url_for('index'))
                
                    lesson = db.session.get(LessonRecord, lesson_id)
                    if lesson is None:
                        app.logger.error(f"Lesson with ID {lesson_id} not found.")
                        return render_template('404.html'), 404
                
                    form = LessonRecordForm(obj=lesson)
                    if request.method == 'GET':
                        form.new_words.data = json.dumps(lesson.new_words)
                        form.new_phrases.data = json.dumps(lesson.new_phrases)
                        app.logger.info(f"Pre-populated form data: new_words={form.new_words.data}, new_phrases={form.new_phrases.data}")
                    
                    if form.validate_on_submit():
                        app.logger.info("Form validated successfully")
                        lesson.lesson_summary = form.lesson_summary.data
                        lesson.strengths = form.strengths.data
                        lesson.areas_to_improve = form.areas_to_improve.data
                        lesson.new_words = process_form_data(form.new_words.data)
                        lesson.new_phrases = process_form_data(form.new_phrases.data)
                
                        teacher = db.session.query(Teacher).get(session['user_id'])
                        lesson.lastEditTime = convert_to_utc(datetime.now(timezone.utc), teacher.timezone)
                        
                        db.session.commit()
                        app.logger.info("Lesson updated successfully")
                        flash('Lesson updated successfully!', 'success')
                        return redirect(url_for('teacher_dashboard'))
                    else:
                        app.logger.error(f"Form validation failed: {form.errors}")
                        app.logger.error(f"Form data: {form.data}")
                        app.logger.error(f"CSRF token: {form.csrf_token.data}")
                        flash('There was an error updating the lesson. Please check your input.', 'error')
                
                    return render_template('teacher/edit_lesson.html', form=form, lesson=lesson)
                