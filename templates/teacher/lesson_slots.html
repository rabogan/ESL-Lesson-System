{% extends "layout.html" %}

{% block title %}
    Manage Lesson Slots
{% endblock %}

{% block main %}
<div class="container mx-auto px-4 bg-white dark:bg-gray-800">
    <h2 class="text-2xl font-bold my-4 text-center text-gray-900 dark:text-white">Manage Lesson Slots</h2>
    
    <div class="flex justify-center my-4 space-x-4">
        <button id="prev-week" class="btn btn-secondary">Previous Week</button>
        <button id="next-week" class="btn btn-secondary">Next Week</button>
    </div>

    <div class="flex justify-center my-4">
        <button id="edit-button" class="btn btn-primary">Edit Slots</button>
    </div>

    <div class="flex justify-center my-4 space-x-4">
        <button id="submit-button" class="btn btn-success hidden">Submit Changes</button>
        <button id="cancel-button" class="btn btn-danger hidden">Cancel</button>
    </div>

    <table id="schedule-grid" class="table-auto w-full border-collapse border border-gray-300">
        <thead>
            <tr class="bg-gray-200 dark:bg-gray-700">
                <th class="border border-gray-300 p-2 dark:text-white">Time</th>
                {% for i in range(7) %}
                <th class="border border-gray-300 p-2 dark:text-white">{{ (start_date + timedelta(days=i)).strftime('%d %b') }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for hour in range(7, 24) %}
            <tr>
                <td class="border border-gray-300 dark:text-white p-2 text-center">{{ '%02d:00' % hour }}</td>
                {% for i in range(7) %}
                {% set slot = lesson_slots | selectattr('start_time', 'equalto', (start_date + timedelta(days=i, hours=hour))) | list | first %}
                <td data-time="{{ (start_date + timedelta(days=i)).strftime('%Y-%m-%d') }} {{ '%02d:00:00' % hour }}" 
                    class="slot border border-gray-300 dark:border-gray-700 p-2 text-center cursor-pointer {% if slot and slot.start_time < datetime.utcnow() %}past-slot{% endif %}">
                    {% if slot %}
                        {% if slot.start_time < datetime.utcnow() %}
                            {% if slot.is_booked %}
                                <span class="status bg-blue-500 text-white rounded p-1" data-slot-id="{{ slot.id }}">Complete</span>
                            {% else %}
                                <span class="status bg-gray-300 dark:bg-gray-600 text-black rounded p-1" data-slot-id="{{ slot.id }}"></span>
                            {% endif %}
                        {% else %}
                            <span class="status {% if slot.is_booked %}bg-blue-500 text-white{% else %}bg-orange-300 text-black{% endif %} rounded p-1" data-slot-id="{{ slot.id }}">
                                {{ 'BOOKED' if slot.is_booked else 'OPEN' }}
                            </span>
                            {% if slot.is_booked %}
                                <div class="text-sm text-gray-700 dark:text-gray-400">Student ID: {{ slot.student_id }}</div>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        {% if (start_date + timedelta(days=i, hours=hour)) > datetime.utcnow() %}
                            <span class="status bg-gray-300 dark:bg-gray-600 text-black rounded p-1"></span>
                        {% endif %}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM fully loaded and parsed');
        let editMode = false;
        let startDate = new Date('{{ start_date.strftime("%Y-%m-%d") }}');

        function updateTable() {
            console.log('Updating table with new start date:', startDate);
            window.location.href = `/teacher/lesson_slots?start_date=${startDate.toISOString().split('T')[0]}`;
        }

        function initializeSlots() {
            console.log('Initializing slots...');
            document.querySelectorAll('.slot').forEach(function (slot) {
                const statusSpan = slot.querySelector('.status');
                console.log('Processing slot:', slot);
                if (statusSpan) {
                    const slotId = statusSpan.getAttribute('data-slot-id');
                    const startTime = slot.getAttribute('data-time');
                    console.log('Slot ID:', slotId, 'Start Time:', startTime);
                    if (statusSpan.classList.contains('bg-blue-500') || slot.classList.contains('past-slot')) {
                        return;
                    }
                    if (slotId) {
                        statusSpan.classList.add('bg-orange-300');
                        statusSpan.classList.remove('bg-gray-300');
                        statusSpan.textContent = 'OPEN';
                    } else {
                        statusSpan.classList.add('bg-gray-300');
                        statusSpan.classList.remove('bg-orange-300');
                        statusSpan.textContent = '';
                    }
                }
            });
        }

        document.querySelectorAll('.slot').forEach(function (slot) {
            slot.addEventListener('click', function () {
                console.log('Slot clicked:', slot);
                if (!editMode) return;

                const statusSpan = slot.querySelector('.status');
                const slotId = statusSpan.getAttribute('data-slot-id');
                const startTime = slot.getAttribute('data-time');

                if (statusSpan.classList.contains('bg-blue-500') || slot.classList.contains('past-slot')) {
                    return;
                }

                statusSpan.classList.toggle('bg-orange-300');
                statusSpan.classList.toggle('bg-gray-300');
                statusSpan.textContent = statusSpan.classList.contains('bg-orange-300') ? 'OPEN' : '';
            });
        });

        document.getElementById('submit-button').addEventListener('click', function () {
            const updates = [];
            document.querySelectorAll('.slot').forEach(function (slot) {
                const statusSpan = slot.querySelector('.status');
                if (statusSpan) {
                    const slotId = statusSpan.getAttribute('data-slot-id');
                    const startTime = slot.getAttribute('data-time');
                    const isOpen = statusSpan.classList.contains('bg-orange-300');
                    if (isOpen && !slotId) {
                        updates.push({ action: 'open', start_time: startTime, end_time: startTime.replace('00:00:00', '00:59:59') });
                    } else if (!isOpen && slotId) {
                        updates.push({ action: 'close', slot_id: slotId });
                    }
                }
            });
            console.log('Updates to be sent:', updates);
            fetch('/teacher/update_slots', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server response:', data);
                if (data.status === 'success') {
                    data.updates.forEach(update => {
                        if (update.action === 'open') {
                            const slotElement = document.querySelector(`[data-time='${update.start_time}'] .status`);
                            slotElement.setAttribute('data-slot-id', update.slot_id);
                            slotElement.classList.remove('bg-gray-300');
                            slotElement.classList.add('bg-orange-300');
                            slotElement.textContent = 'OPEN';
                        } else if (update.action === 'close') {
                            const slotElement = document.querySelector(`[data-slot-id='${update.slot_id}']`);
                            slotElement.classList.remove('bg-orange-300');
                            slotElement.classList.add('bg-gray-300');
                            slotElement.textContent = '';
                            slotElement.removeAttribute('data-slot-id');
                        }
                    });
                    editMode = false;
                    document.getElementById('edit-button').classList.remove('hidden');
                    document.getElementById('submit-button').classList.add('hidden');
                    document.getElementById('cancel-button').classList.add('hidden');
                    initializeSlots();
                } else {
                    alert('An error occurred.');
                }
            });
        });

        document.getElementById('edit-button').addEventListener('click', function () {
            console.log('Edit mode enabled');
            editMode = true;
            document.getElementById('edit-button').classList.add('hidden');
            document.getElementById('submit-button').classList.remove('hidden');
            document.getElementById('cancel-button').classList.remove('hidden');
            initializeSlots();
        });

        document.getElementById('cancel-button').addEventListener('click', function () {
            console.log('Edit mode cancelled');
            editMode = false;
            document.getElementById('edit-button').classList.remove('hidden');
            document.getElementById('submit-button').classList.add('hidden');
            document.getElementById('cancel-button').classList.add('hidden');
            updateTable();
        });


        // Navigate to the previous week
        document.getElementById('prev-week').addEventListener('click', function () {
            console.log('Previous week clicked');
            startDate.setDate(startDate.getDate() - 7);
            updateTable();
        });

        // Navigate to the next week
        document.getElementById('next-week').addEventListener('click', function () {
            console.log('Next week clicked');
            startDate.setDate(startDate.getDate() + 7);
            updateTable();
        });

        // Initialize the table immediately on page load
        initializeSlots();
    });
</script>
{% endblock %}
