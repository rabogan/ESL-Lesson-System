{% extends "layout.html" %}

{% block title %}
    Manage Lesson Slots
{% endblock %}

{% block main %}
<section class="bg-white dark:bg-gray-900">
    <div class="max-w-screen-xl px-4 py-8 mx-auto lg:py-16">
        <h1 class="text-3xl font-extrabold leading-none tracking-tight md:text-5xl xl:text-6xl dark:text-white mb-8 text-center">
            Manage Lesson Slots
        </h1>

        <form id="unique-lessonSlotsForm" method="POST">
            {{ form.hidden_tag() }}
        </form>
        
        <div class="flex dark:text-white justify-center my-4 space-x-4">
            <button id="unique-prev-week" class="btn btn-secondary">Previous Week</button>
            <button id="unique-next-week" class="btn btn-secondary">Next Week</button>
        </div>
        
        <div class="flex dark:text-white justify-center my-4">
            <button id="unique-edit-button" class="btn btn-primary">Edit Slots</button>
        </div>
        
        <div class="flex justify-center dark:text-white my-4 space-x-4">
            <button id="unique-submit-button" class="btn btn-success hidden">Submit Changes</button>
            <button id="unique-cancel-button" class="btn btn-danger hidden">Cancel</button>
        </div>

        <div id="tableContainer"></div> <!-- Container for the generated table -->
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        console.log("Document is ready!");

        let currentStartDate = new Date();
        currentStartDate.setDate(currentStartDate.getDate() - (currentStartDate.getDay() === 0 ? 6 : currentStartDate.getDay() - 1));
        currentStartDate.setHours(0, 0, 0, 0);

        let changes = [];

        // Extract CSRF token from the hidden form field
        const csrfToken = $('input[name="csrf_token"]').val();

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrfToken);
                }
            }
        });

        // Function to update the table with received data
        function updateTable(data) {
            console.log('Data received in updateTable:', data);
            const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            let headerRow = '<tr class="bg-gray-200 dark:bg-gray-700"><th class="border border-gray-300 dark:border-gray-600 p-2 dark:text-gray-100">Time</th>';

            // Create the header row for the dates
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentStartDate);
                date.setDate(currentStartDate.getDate() + i);
                headerRow += `<th class="border border-gray-300 dark:border-gray-600 p-2 dark:text-gray-100">${daysOfWeek[i]} ${date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' })}</th>`;
            }
            headerRow += '</tr>';

            // Create the body rows for each hour
            let bodyRows = '';
            for (let hour = 7; hour <= 23; hour++) {
                bodyRows += `<tr><td class="border border-gray-300 dark:border-gray-600 dark:text-gray-100 p-2 text-center">${hour}:00</td>`;
                for (let i = 0; i < 7; i++) {
                    const cellTime = new Date(currentStartDate);
                    cellTime.setDate(currentStartDate.getDate() + i);
                    cellTime.setHours(hour, 0, 0, 0);

                    const slot = data.find(slot => new Date(slot.start_time).getTime() === cellTime.getTime());
                    let cellClass = 'bg-gray-300 text-black text-center';
                    let cellContent = '-';
                    let dataSlotId = '';
                    let clickHandler = '';
                    let dataTime = `data-time="${cellTime.toISOString()}"`;

                    if (slot) {
                        if (slot.status === 'Booked') {
                            cellClass = 'bg-blue-500 text-white text-center';
                            cellContent = 'BOOKED';
                        } else if (slot.status === 'Available') {
                            cellClass = 'bg-gold-300 text-black text-center';
                            cellContent = 'OPEN LESSON';
                            dataSlotId = `data-slot-id="${slot.slot_id}"`;
                            clickHandler = `onclick="toggleSlotStatus(this, 'close')"`;
                        }
                    } else {
                        clickHandler = `onclick="toggleSlotStatus(this, 'open')"`;
                    }

                    // Disable past slots
                    if (cellTime < new Date()) {
                        cellClass = 'bg-gray-200 text-black text-center cursor-not-allowed';
                        clickHandler = '';
                    }

                    bodyRows += `<td class="border border-gray-300 dark:border-gray-600 p-2 ${cellClass}" ${dataSlotId} ${clickHandler} ${dataTime}>${cellContent}</td>`;
                }
                bodyRows += '</tr>';
            }

            const tableHtml = `<table class="table-auto w-full border-collapse border border-gray-300 dark:border-gray-700 mt-8"><thead>${headerRow}</thead><tbody>${bodyRows}</tbody></table>`;
            document.getElementById('tableContainer').innerHTML = tableHtml;
        }

        // Function to toggle slot status
        window.toggleSlotStatus = function(cell, action) {
            const cellTime = new Date($(cell).data('time'));
            let slotId = $(cell).data('slot-id');

            // Do nothing if the slot is booked or in the past
            if ($(cell).hasClass('bg-blue-500') || $(cell).hasClass('cursor-not-allowed')) {
                return;
            }

            if (action === 'open') {
                // Mark the cell as open lesson
                $(cell).removeClass('bg-gray-300').addClass('bg-gold-300').text('OPEN LESSON');
                changes.push({ action: 'open', start_time: cellTime.toISOString(), end_time: new Date(cellTime.getTime() + 60 * 60 * 1000).toISOString() });
            } else if (action === 'close') {
                // Mark the cell as closed
                $(cell).removeClass('bg-gold-300').addClass('bg-orange-300').text('CLOSED');
                changes.push({ action: 'close', slot_id: slotId });
                $(cell).attr('onclick', "toggleSlotStatus(this, 'undo')");
            } else if (action === 'undo') {
                // Revert the cell back to open lesson
                $(cell).removeClass('bg-orange-300').addClass('bg-gold-300').text('OPEN LESSON');
                changes = changes.filter(change => change.slot_id !== slotId);
                $(cell).attr('onclick', "toggleSlotStatus(this, 'close')");
            }
        };

        // Function to send an AJAX request to get lesson slots
        function sendDateRequest(offset) {
            currentStartDate.setDate(currentStartDate.getDate() + offset);
            let dataToSend = {
                start_date: currentStartDate.toISOString().slice(0, 19)
            };

            console.log('Data being sent:', dataToSend);

            $.ajax({
                url: '/teacher/lesson_slots',
                type: 'GET',
                data: dataToSend,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    console.log('AJAX success response:', response);
                    updateTable(response); // Update the table even if the response is empty
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX request failed: " + textStatus + ", " + errorThrown);
                    console.error("Response text:", jqXHR.responseText);
                    // Revert the currentStartDate if the request fails
                    currentStartDate.setDate(currentStartDate.getDate() - offset);
                }
            });
        }

        // Event listeners for the navigation buttons
        $('#unique-prev-week').click(function() {
            sendDateRequest(-7);
        });

        $('#unique-next-week').click(function() {
            sendDateRequest(7);
        });

        // Event listener for the edit button
        $('#unique-edit-button').click(function() {
            $('#unique-submit-button').removeClass('hidden');
            $('#unique-cancel-button').removeClass('hidden');
            $('#unique-edit-button').addClass('hidden');
        });

        // Event listener for the submit button
        $('#unique-submit-button').click(function() {
            if (changes.length === 0) {
                alert('No changes to submit.');
                return;
            }

            if (!confirm('Are you sure you want to submit the changes?')) {
                return;
            }

            $.ajax({
                url: '/teacher/update_slots',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(changes),
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    console.log('AJAX success response:', response);
                    if (response.status === 'success') {
                        alert('Changes submitted successfully.');
                        changes = [];
                        $('#unique-submit-button').addClass('hidden');
                        $('#unique-cancel-button').addClass('hidden');
                        $('#unique-edit-button').removeClass('hidden');
                        sendDateRequest(0); // Reload the current week's schedule
                    } else {
                        alert('Error submitting changes: ' + response.message);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX request failed: " + textStatus + ", " + errorThrown);
                    console.error("Response text:", jqXHR.responseText);
                    alert('Error submitting changes.');
                }
            });
        });

        // Event listener for the cancel button
        $('#unique-cancel-button').click(function() {
            changes = [];
            $('#unique-submit-button').addClass('hidden');
            $('#unique-cancel-button').addClass('hidden');
            $('#unique-edit-button').removeClass('hidden');
            sendDateRequest(0); // Reload the current week's schedule
        });

        // Initial load of the current week's schedule
        sendDateRequest(0);
    });
</script>
{% endblock %}
