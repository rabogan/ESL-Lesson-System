{% extends "layout.html" %}

{% block title %}
    Manage Lesson Slots
{% endblock %}

{% block main %}
<section class="bg-white dark:bg-gray-900">
    <div class="max-w-screen-xl px-4 py-8 mx-auto lg:py-16">
        <h1 class="text-3xl font-extrabold leading-none tracking-tight md:text-5xl xl:text-6xl dark:text-white mb-8 text-center">
            Manage Lesson Slots
        </h1>

        <form id="unique-lessonSlotsForm" method="POST">
            {{ form.hidden_tag() }}
        </form>
        
        <div class="flex dark:text-white justify-center my-4 space-x-4">
            <button id="unique-prev-week" class="btn btn-secondary">Previous Week</button>
            <button id="unique-next-week" class="btn btn-secondary">Next Week</button>
        </div>
        
        <div class="flex dark:text-white justify-center my-4">
            <button id="unique-edit-button" class="btn btn-primary">Edit Slots</button>
        </div>
        
        <div class="flex justify-center dark:text-white my-4 space-x-4">
            <button id="unique-submit-button" class="btn btn-success hidden">Submit Changes</button>
            <button id="unique-cancel-button" class="btn btn-danger hidden">Cancel</button>
        </div>

        <table id="unique-schedule-grid" class="table-auto w-full border-collapse border border-gray-300 dark:border-gray-700 mt-8">
            <thead>
                <tr class="bg-gray-200 dark:bg-gray-700">
                    <th class="border border-gray-300 dark:border-gray-600 p-2 dark:text-gray-100">Time</th>
                    {% for i in range(7) %}
                    <th class="border border-gray-300 dark:border-gray-600 p-2 dark:text-gray-100">{{ (start_date + timedelta(days=i)).strftime('%d %b') }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hour in range(7, 24) %}
                <tr>
                    <td class="border border-gray-300 dark:border-gray-600 dark:text-gray-100 p-2 text-center">{{ '%02d:00' % hour }}</td>
                    {% for i in range(7) %}
                    {% set slot = lesson_slots | selectattr('start_time', 'equalto', (start_date + timedelta(days=i, hours=hour)).astimezone(pytz.UTC)) | list | first %}
                    <td data-time="{{ (start_date + timedelta(days=i, hours=hour)).astimezone(pytz.UTC).isoformat() }}" 
                        class="slot border border-gray-300 dark:border-gray-600 p-2 text-center cursor-pointer {% if slot and slot.start_time < datetime.now(user_timezone) %}past-slot{% endif %}">
                        {% if slot %}
                            {% if slot.start_time < datetime.now(user_timezone) %}
                                {% if slot.is_booked %}
                                    <div class="bg-blue-500 text-white rounded p-1 h-full flex items-center justify-center" data-slot-id="{{ slot.id }}">BOOKED</div>
                                {% else %}
                                    <div class="bg-gray-300 dark:bg-gray-600 text-black dark:text-gray-100 rounded p-1 h-full flex items-center justify-center" data-slot-id="{{ slot.id }}">-</div>
                                {% endif %}
                            {% else %}
                                <div class="h-full flex items-center justify-center {% if slot.is_booked %}bg-blue-500 text-white{% else %}bg-gold-300 text-black{% endif %} rounded p-1" data-slot-id="{{ slot.id }}">
                                    {{ 'BOOKED' if slot.is_booked else 'OPEN LESSON' }}
                                </div>
                            {% endif %}
                        {% else %}
                            {% if (start_date + timedelta(days=i, hours=hour)).astimezone(user_timezone) > datetime.now(user_timezone) %}
                                <div class="bg-gray-300 dark:bg-gray-600 text-black dark:text-gray-100 rounded p-1 h-full flex items-center justify-center">-</div>
                            {% endif %}
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
<script>
    (function() {
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM fully loaded and parsed');
            let editMode = false;
            let startDate = new Date('{{ start_date.strftime("%Y-%m-%d") }}');
            console.log('Start Date:', startDate);

            function updateTable() {
                console.log('Updating table');
                window.location.href = `/teacher/lesson_slots?start_date=${startDate.toISOString().split('T')[0]}`;
            }

            function initializeSlots() {
                console.log('Initializing slots');
                document.querySelectorAll('.slot').forEach(function (slot) {
                    const statusDiv = slot.querySelector('div');
                    if (statusDiv) {
                        const slotId = statusDiv.getAttribute('data-slot-id');
                        if (statusDiv.classList.contains('bg-blue-500') || slot.classList.contains('past-slot')) {
                            return;
                        }
                        if (slotId) {
                            console.log(`Slot ID ${slotId} is already open`);
                            statusDiv.classList.add('bg-gold-300');
                            statusDiv.classList.remove('bg-gray-300');
                            statusDiv.textContent = 'OPEN LESSON';
                        } else {
                            console.log('Slot is not open yet');
                            statusDiv.classList.add('bg-gray-300');
                            statusDiv.classList.remove('bg-gold-300');
                            statusDiv.textContent = '-';
                        }
                    }
                });
            }

            document.querySelectorAll('.slot').forEach(function (slot) {
                slot.addEventListener('click', function () {
                    if (!editMode) return;

                    const statusDiv = slot.querySelector('div');
                    const slotId = statusDiv.getAttribute('data-slot-id');
                    console.log('Clicked slot ID:', slotId);

                    if (statusDiv.classList.contains('bg-blue-500') || slot.classList.contains('past-slot')) {
                        return;
                    }

                    statusDiv.classList.toggle('bg-gold-300');
                    statusDiv.classList.toggle('bg-gray-300');
                    statusDiv.textContent = statusDiv.classList.contains('bg-gold-300') ? 'OPEN LESSON' : '-';
                });
            });

            document.getElementById('unique-submit-button').addEventListener('click', function () {
                console.log('Submit button clicked');
                const updates = [];
                document.querySelectorAll('.slot').forEach(function (slot) {
                    const statusDiv = slot.querySelector('div');
                    if (statusDiv) {
                        const slotId = statusDiv.getAttribute('data-slot-id');
                        const startTime = new Date(slot.getAttribute('data-time')).toISOString().split('.')[0] + 'Z';
                        const isOpen = statusDiv.classList.contains('bg-gold-300');
                        console.log(`Processing slot with ID ${slotId}, Start time: ${startTime}, Is open: ${isOpen}`);
                        if (isOpen && !slotId) {
                            updates.push({ action: 'open', start_time: startTime, end_time: new Date(new Date(startTime).getTime() + 60 * 60 * 1000).toISOString().split('.')[0] + 'Z' });
                        } else if (!isOpen && slotId) {
                            updates.push({ action: 'close', slot_id: slotId });
                        }
                    }
                });

                console.log('Payload:', JSON.stringify(updates));  // Log the payload

                // Get the CSRF token from the hidden input field
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                console.log('CSRF Token:', csrfToken);  // Log the CSRF token

                fetch('/teacher/update_slots', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken  // Include the CSRF token in the request headers
                    },
                    body: JSON.stringify(updates)
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response status text:', response.statusText);
                    if (!response.ok) {
                        return response.text().then(errorText => {
                            console.error('Response error body:', errorText);
                            throw new Error('Network response was not ok ' + response.statusText);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response:', data);  // Log the response
                    if (data.status === 'success') {
                        if (data.updates && Array.isArray(data.updates)) {
                            data.updates.forEach(update => {
                                console.log('Processing update:', update);
                                const startTime = update.start_time.split('.')[0] + 'Z';
                                if (update.action === 'open') {
                                    const slotElement = document.querySelector(`[data-time='${startTime}'] div`);
                                    if (!slotElement) {
                                        console.error(`No slot element found for data-time='${startTime}'`);
                                    } else {
                                        slotElement.setAttribute('data-slot-id', update.slot_id);
                                        slotElement.classList.remove('bg-gray-300');
                                        slotElement.classList.add('bg-gold-300');
                                        slotElement.textContent = 'OPEN LESSON';
                                    }
                                } else if (update.action === 'close') {
                                    const slotElement = document.querySelector(`[data-slot-id='${update.slot_id}']`);
                                    if (!slotElement) {
                                        console.error(`No slot element found for data-slot-id='${update.slot_id}'`);
                                    } else {
                                        slotElement.classList.remove('bg-gold-300');
                                        slotElement.classList.add('bg-gray-300');
                                        slotElement.textContent = '-';
                                        slotElement.removeAttribute('data-slot-id');
                                    }
                                }
                            });
                        } else {
                            console.error('Updates not found in response:', data);
                        }
                        editMode = false;
                        document.getElementById('unique-edit-button').classList.remove('hidden');
                        document.getElementById('unique-submit-button').classList.add('hidden');
                        document.getElementById('unique-cancel-button').classList.add('hidden');
                        initializeSlots();
                    } else {
                        alert('An error occurred.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);  // Log any errors
                    alert('An error occurred: ' + error.message);
                });
            });

            document.getElementById('unique-edit-button').addEventListener('click', function () {
                console.log('Edit button clicked');
                editMode = true;
                document.getElementById('unique-edit-button').classList.add('hidden');
                document.getElementById('unique-submit-button').classList.remove('hidden');
                document.getElementById('unique-cancel-button').classList.remove('hidden');
                initializeSlots();
            });

            document.getElementById('unique-cancel-button').addEventListener('click', function () {
                console.log('Cancel button clicked');
                editMode = false;
                document.getElementById('unique-edit-button').classList.remove('hidden');
                document.getElementById('unique-submit-button').classList.add('hidden');
                document.getElementById('unique-cancel-button').classList.add('hidden');
                updateTable();
            });

            document.getElementById('unique-prev-week').addEventListener('click', function () {
                console.log('Previous week button clicked');
                startDate.setDate(startDate.getDate() - 7);
                updateTable();
            });

            document.getElementById('unique-next-week').addEventListener('click', function () {
                console.log('Next week button clicked');
                startDate.setDate(startDate.getDate() + 7);
                updateTable();
            });

            initializeSlots();
        });
    })();
</script>
{% endblock %}
