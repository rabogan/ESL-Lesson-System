<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Lesson Slots</title>
    <style>
        .hidden { display: none; }
        .bg-blue-500 { background-color: #3b82f6; color: white; }
        .bg-gold-300 { background-color: #ffeb3b; color: black; }
        .bg-gray-300 { background-color: #d1d5db; color: black; }
        .bg-gray-600 { background-color: #4b5563; color: white; }
        .past-slot { background-color: #9ca3af; color: white; }
        .btn { padding: 0.5rem 1rem; border: none; cursor: pointer; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
    </style>
</head>
<body>
<section>
    <div>
        <h1>Manage Lesson Slots</h1>

        <form id="lessonSlotsForm" method="POST">
            <!-- CSRF Token -->
            <input type="hidden" name="csrf_token" value="ImVkMmY0ZGM0ZGVhZDJjMGVkYTdmMTYzOWIzY2RiZTYyOTA3NjZhM2Ii.Zlp41A.elW0lYsq5MbcbN0vmLkEyesZEIg">
        </form>
        
        <div>
            <button id="prev-week" class="btn btn-secondary">Previous Week</button>
            <button id="next-week" class="btn btn-secondary">Next Week</button>
        </div>
        
        <div>
            <button id="edit-button" class="btn btn-primary">Edit Slots</button>
        </div>
        
        <div>
            <button id="submit-button" class="btn btn-success hidden">Submit Changes</button>
            <button id="cancel-button" class="btn btn-danger hidden">Cancel</button>
        </div>

        <table id="schedule-grid">
            <thead>
                <tr>
                    <th>Time</th>
                    <!-- Adjust the date range according to your needs -->
                    <th data-date="2024-06-03">03 Jun</th>
                    <th data-date="2024-06-04">04 Jun</th>
                    <th data-date="2024-06-05">05 Jun</th>
                    <th data-date="2024-06-06">06 Jun</th>
                    <th data-date="2024-06-07">07 Jun</th>
                    <th data-date="2024-06-08">08 Jun</th>
                    <th data-date="2024-06-09">09 Jun</th>
                </tr>
            </thead>
            <tbody>
                <!-- Adjust the time range according to your needs -->
                {% for hour in range(7, 24) %}
                <tr>
                    <td>{{ '%02d:00' % hour }}</td>
                    {% for day in range(7) %}
                    <td data-time="{{ (start_date + timedelta(days=day, hours=hour)).astimezone(pytz.UTC).isoformat() }}" class="slot">
                        <!-- Slot content here -->
                        <div class="bg-gray-300"></div>
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let editMode = false;
        let startDate = new Date('2024-06-03');

        function updateTable() {
            window.location.href = `/teacher/lesson_slots?start_date=${startDate.toISOString().split('T')[0]}`;
        }

        function initializeSlots() {
            document.querySelectorAll('.slot').forEach(function (slot) {
                const statusDiv = slot.querySelector('div');
                if (statusDiv) {
                    const slotId = statusDiv.getAttribute('data-slot-id');
                    if (statusDiv.classList.contains('bg-blue-500') || slot.classList.contains('past-slot')) {
                        return;
                    }
                    if (slotId) {
                        statusDiv.classList.add('bg-gold-300');
                        statusDiv.classList.remove('bg-gray-300');
                        statusDiv.textContent = 'ADD SLOT';
                    } else {
                        statusDiv.classList.add('bg-gray-300');
                        statusDiv.classList.remove('bg-gold-300');
                        statusDiv.textContent = '';
                    }
                }
            });
        }

        document.querySelectorAll('.slot').forEach(function (slot) {
            slot.addEventListener('click', function () {
                if (!editMode) return;

                const statusDiv = slot.querySelector('div');
                const slotId = statusDiv.getAttribute('data-slot-id');

                if (statusDiv.classList.contains('bg-blue-500') || slot.classList.contains('past-slot')) {
                    return;
                }

                statusDiv.classList.toggle('bg-gold-300');
                statusDiv.classList.toggle('bg-gray-300');
                statusDiv.textContent = statusDiv.classList.contains('bg-gold-300') ? 'ADD SLOT' : '';
            });
        });

        document.getElementById('submit-button').addEventListener('click', function () {
            const updates = [];
            document.querySelectorAll('.slot').forEach(function (slot) {
                const statusDiv = slot.querySelector('div');
                if (statusDiv) {
                    const slotId = statusDiv.getAttribute('data-slot-id');
                    const startTime = new Date(slot.getAttribute('data-time')).toISOString().split('.')[0] + 'Z';
                    const isOpen = statusDiv.classList.contains('bg-gold-300');
                    if (isOpen && !slotId) {
                        updates.push({ action: 'open', start_time: startTime, end_time: new Date(new Date(startTime).getTime() + 60 * 60 * 1000).toISOString().split('.')[0] + 'Z' });
                    } else if (!isOpen && slotId) {
                        updates.push({ action: 'close', slot_id: slotId });
                    }
                }
            });

            console.log('Payload:', JSON.stringify(updates));  // Log the payload

            // Get the CSRF token from the hidden input field
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            console.log('CSRF Token:', csrfToken);  // Log the CSRF token

            fetch('/teacher/update_slots', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken  // Include the CSRF token in the request headers
                },
                body: JSON.stringify(updates)
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response status text:', response.statusText);
                if (!response.ok) {
                    return response.text().then(errorText => {
                        console.error('Response error body:', errorText);
                        throw new Error('Network response was not ok ' + response.statusText);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Response:', data);  // Log the response
                if (data.status === 'success') {
                    if (data.updates && Array.isArray(data.updates)) {
                        data.updates.forEach(update => {
                            console.log('Processing update:', update);
                            const startTime = update.start_time.split('.')[0] + 'Z';
                            if (update.action === 'open') {
                                const slotElement = document.querySelector(`[data-time='${startTime}'] div`);
                                if (!slotElement) {
                                    console.error(`No slot element found for data-time='${startTime}'`);
                                } else {
                                    slotElement.setAttribute('data-slot-id', update.slot_id);
                                    slotElement.classList.remove('bg-gray-300');
                                    slotElement.classList.add('bg-gold-300');
                                    slotElement.textContent = 'ADD SLOT';
                                }
                            } else if (update.action === 'close') {
                                const slotElement = document.querySelector(`[data-slot-id='${update.slot_id}']`);
                                if (!slotElement) {
                                    console.error(`No slot element found for data-slot-id='${update.slot_id}'`);
                                } else {
                                    slotElement.classList.remove('bg-gold-300');
                                    slotElement.classList.add('bg-gray-300');
                                    slotElement.textContent = '';
                                    slotElement.removeAttribute('data-slot-id');
                                }
                            }
                        });
                    } else {
                        console.error('Updates not found in response:', data);
                    }
                    editMode = false;
                    document.getElementById('edit-button').classList.remove('hidden');
                    document.getElementById('submit-button').classList.add('hidden');
                    document.getElementById('cancel-button').classList.add('hidden');
                    initializeSlots();
                } else {
                    alert('An error occurred.');
                }
            })
            .catch(error => {
                console.error('Error:', error);  // Log any errors
                alert('An error occurred: ' + error.message);
            });
        });

        document.getElementById('edit-button').addEventListener('click', function () {
            editMode = true;
            document.getElementById('edit-button').classList.add('hidden');
            document.getElementById('submit-button').classList.remove('hidden');
            document.getElementById('cancel-button').classList.remove('hidden');
            initializeSlots();
        });

        document.getElementById('cancel-button').addEventListener('click', function () {
            editMode = false;
            document.getElementById('edit-button').classList.remove('hidden');
            document.getElementById('submit-button').classList.add('hidden');
            document.getElementById('cancel-button').classList.add('hidden');
            updateTable();
        });

        document.getElementById('prev-week').addEventListener('click', function () {
            startDate.setDate(startDate.getDate() - 7);
            updateTable();
        });

        document.getElementById('next-week').addEventListener('click', function () {
            startDate.setDate(startDate.getDate() + 7);
            updateTable();
        });

        initializeSlots();
    });
</script>
</body>
</html>
